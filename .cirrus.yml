---

# Only github users with write-access can define or use encrypted variables
# This credential represents a service account with access to manage both VMs
# and storage.
gcp_credentials: ENCRYPTED[885c6e4297dd8d6f67593c42b810353af0c505a7a670e2c6fd830c56e86bbb2debcc3c18f942d0d46ab36b63521061d4]

# Default VM to use for testing, unless values overriden by specific tasks (below)
gce_instance:
    image_project: "libpod-218412"
    zone: "us-central1-a"  # Required by Cirrus for the time being
    cpu: 2
    memory: "4Gb"
    disk: 40

# Main collection of env. varss to set for all scripts. All others
# are cooked in by $SCRIPT_BASE/setup_environment.sh
env:
    FEDORA_CNI_COMMIT: "412b6d31280682bb4fab4446f113c22ff1886554"
    CNI_COMMIT: "7480240de9749f9a0a5c8614b17f1f03e0c06ab9"
    CRIO_COMMIT: "662dbb31b5d4f5ed54511a47cde7190c61c28677"
    CRIU_COMMIT: "584cbe4643c3fc7dc901ff08bf923ca0fe7326f9"
    RUNC_COMMIT: "78ef28e63bec2ee4c139b5e3e0d691eb9bdc748d"
    # File to update in home-dir with task-specific env. var values
    ENVLIB: ".bash_profile"
    # Overrides default location (/tmp/cirrus) for repo clone
    CIRRUS_WORKING_DIR: "/go/src/github.com/containers/libpod"
    # Required so $ENVLIB gets loaded
    CIRRUS_SHELL: "/bin/bash"
    # Save a little typing (path relative to $CIRRUS_WORKING_DIR)
    SCRIPT_BASE: "./contrib/cirrus"
    PACKER_BASE: "./contrib/cirrus/packer"
    IRCID: ENCRYPTED[e87bba62a8e924dc70bdb2b66b16f6ab4a60d2870e6e5534ae9e2b0076f483c71c84091c655ca239101e6816c5ec0883]

# Every *_task runs in parallel in separate VMs. The name prefix only for reference
# in WebUI, and will be followed by matrix details.  This task does all the
# per-pr unit/integration testing.
full_vm_testing_task:

    gce_instance:
        # Generate multiple 'test' tasks, covering all possible
        # 'matrix' combinations.  All run in parallel.
        matrix:
            # Images are generated separetly, from build_images_task (below)
            image_name: "ubuntu-1804-bionic-v20180911-libpod-63a86a18"
            image_name: "fedora-atomic-host-28-1-1-2"
            image_name: "fedora-cloud-base-28-1-1-7-libpod-fce09afe"
            # TODO: Make these work (also build_images_task below)
            #image_name: "centos-7-v20180911-libpod-fce09afe"
            #image_name: "rhel-server-ec2-7-5-165-1-libpod-fce09afe"

    timeout_in: 120m

    # Every *_script runs in sequence, for each task. The name prefix is for
    # WebUI reference.  The values may be strings...
    setup_environment_script: $SCRIPT_BASE/setup_environment.sh

    # ...or lists of strings
    verify_source_script:
        - whoami  # root!
        - $SCRIPT_BASE/verify_source.sh

    unit_test_script: $SCRIPT_BASE/unit_test.sh

    integration_test_script: $SCRIPT_BASE/integration_test.sh

    success_script: $SCRIPT_BASE/success.sh


# This task build new images for future PR testing, but only after a PR merge.
# These images save needing to install/setup the same environment to test every
# PR.  The 'active' image for testing is selected by the 'image_name' items in
# task above.  Currently this requires manually updating them, but this could
# be automated (see comment at end).

build_vm_images_task:
    # Only produce new images after a PR merge
    only_if: $CIRRUS_BRANCH == 'master'

    # Require tests to pass first.
    depends_on:
        - test  # i.e. 'test_task'

    env:
        # CSV of packer builder names to enable (see $PACKER_BASE/libpod_images.json)
<<<<<<< HEAD
        PACKER_BUILDS: "ubuntu-18"
        # TODO: Make these work (also full_vm_testing_task above)
        # PACKER_BUILDS: "rhel-7,centos-7,fedora-28,ubuntu-18"
=======
        PACKER_BUILDS: "rhel-7,centos-7,ubuntu-18,fedora-28,fah-28"
        # Command to register a RHEL VM
        RHSM_COMMAND: ENCRYPTED[fec01433222af1ed0b8e40e89e7d18f6ee2fa9f49a1e721dc72f7eed3c740661215d1bd05cb54ac66a1a62116b92bdce]
        # Additional environment variables needed to build GCE images, within a GCE VM
        SERVICE_ACCOUNT: ENCRYPTED[02e03838b1156eb9516c7cc1e888e287910759842275f3c7bc2b4d56075cc6740e29ffa0ab71ebdbbd079673361dd8c9]
        GCE_SSH_USERNAME: ENCRYPTED[a19a4ec62423e3e0fe4e7d1a5c9f11eda8fde321b9047ab5ed5590c2b1d7a2d12091c2be1531f949eae927059c2ae531]
        GCP_PROJECT_ID: ENCRYPTED[77cb2d392bbc8d17412547d7d91f8d190089bf6e6b96eab9927994bbff6ab2c691ba0329ac7a650ba6182fbbab9fb68d]
        # Existing base values to use, output images get epoc stamped names
        PACKER_VER: "1.3.1"

        # low-level base VM image name inputs to packer
>>>>>>> 51e12380... Cirrus: Build F28 & FAH28 images and test them
        CENTOS_BASE_IMAGE: "centos-7-v20180911"
        RHEL_BASE_IMAGE: "rhel-server-ec2-7-5-165-1"
        UBUNTU_BASE_IMAGE: "ubuntu-1804-bionic-v20180911"
        # low-level base VM image name inputs to packer

        # Command to register a RHEL VM
        RHSM_COMMAND: ENCRYPTED[5caa5ff8c5370c3d25c7a1a28168501ab0fa2e5e3b627926f6eaba02b3fed965a7638a6151657809661f8c905c7dc187]
        # Additional environment variables needed to build GCE images, within a GCE VM
        SERVICE_ACCOUNT: ENCRYPTED[99e9a0b1c23f8dd29e83dfdf164f064cfd17afd9b895ca3b5e4c41170bd4290a8366fe2ad8e7a210b9f751711d1d002a]
        GCE_SSH_USERNAME: ENCRYPTED[a7706b9e4b8bbb47f76358df7407f4fffa2e8552531190cc0b3315180c4b50588f560c4f85731e99cb5f43a396778277]
        GCP_PROJECT_ID: ENCRYPTED[7c80e728e046b1c76147afd156a32c1c57d4a1ac1eab93b7e68e718c61ca8564fc61fef815952b8ae0a64e7034b8fe4f]
        # Version of packer to use
        PACKER_VER: "1.3.1"


        # Fedora + FAH images are loaded into nested-virts to add GCE services.
        FEDORA_IMAGE_PREFIX: "fedora-cloud-base-29-1-2"  # GCE friendly image name
        FEDORA_IMAGE_URL: "https://dl.fedoraproject.org/pub/fedora/linux/releases/28/Cloud/x86_64/images/Fedora-Cloud-Base-28-1.1.x86_64.qcow2"
        FEDORA_CSUM_URL: "https://dl.fedoraproject.org/pub/fedora/linux/releases/28/Cloud/x86_64/images/Fedora-Cloud-28-1.1-x86_64-CHECKSUM"
        FAH_IMAGE_PREFIX: "Fedora-AtomicHost-29-20181025-1"  # GCE friendly image name
        FAH_IMAGE_URL: "https://dl.fedoraproject.org/pub/alt/atomic/stable/Fedora-Atomic-29-20181025.1/AtomicHost/x86_64/images/Fedora-AtomicHost-29-20181025.1.x86_64.raw.xz"
        FAH_CSUM_URL: "https://dl.fedoraproject.org/pub/alt/atomic/stable/Fedora-Atomic-29-20181025.1/AtomicHost/x86_64/images/Fedora-AtomicHost-29-20181025.1-x86_64-CHECKSUM"

    gce_instance:
        image_name: "image-builder-image-3"  # Simply CentOS 7 + packer + nested virt
        # Additional permissions for building GCE images, within a GCE VM
        scopes:
            - compute
            - devstorage.full_control
        # Doesn't need many local resources to run
        cpu: 2
        memory: "2Gb"
        disk: 20
    environment_script: $SCRIPT_BASE/setup_environment.sh
    build_vm_images_script: $SCRIPT_BASE/build_vm_images.sh

    # TODO,Continuous Delivery: Automaticly open a libpod PR after using 'sed' to replace
    #                           the image_names with the new (just build) images.  That will
    #                           cause a new round of testing to happen (via the PR) using
    #                           the new images.  When all is good, the PR may be manually
    #                           merged so all PR testing uses the new images.  The script
    #                           names (below) describe their purpose in this workflow.
    # deploy_images_script:
    #   - clone_podman_release_branch.sh
    #   - modify_cirrus_yaml_image_names.sh
    #   - commit_and_create_upstream_pr.sh
